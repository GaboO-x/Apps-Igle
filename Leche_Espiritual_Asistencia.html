<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control de Unidades 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --URT: #dc3545; --UVT: #28a745; --UAzT: #007bff; --UAmT: #ffc107; --UNT: #fd7e14;
        }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #f0f2f5; 
            padding: 5px; 
            margin: 0;
            color: #333; 
            font-size: 14px;
        }

        #capture-area { 
            max-width: 100%; 
            margin: auto; 
            background: white; 
            padding: 8px; 
            border-radius: 10px; 
        }

        .header-top { 
            display: flex; 
            justify-content: space-around; 
            gap: 8px; 
            margin-bottom: 12px; 
            background: #fff; 
            padding: 8px; 
            border-radius: 8px; 
            border: 1px solid #ddd;
        }

        .input-group { display: flex; flex-direction: column; align-items: center; flex: 1; }
        label { font-size: 0.6em; font-weight: bold; margin-bottom: 3px; color: #888; text-transform: uppercase; }
        input[type="date"], select { width: 100%; padding: 4px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.85em; background: white; }

        .unit-section { margin-bottom: 12px; border-radius: 8px; overflow: hidden; border: 1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .unit-header { color: white; padding: 6px 12px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 0.85em; }
        
        .bg-urt { background-color: var(--URT); }
        .bg-uvt { background-color: var(--UVT); }
        .bg-uazt { background-color: var(--UAzT); }
        .bg-uamt { background-color: var(--UAmT); color: #333 !important; }
        .bg-unt { background-color: var(--UNT); }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; min-width: 600px; } 
        
        th, td { padding: 4px 2px; text-align: center; border-bottom: 1px solid #eee; }
        th { font-size: 0.5em; background: #fcfcfc; color: #aaa; position: sticky; top: 0; z-index: 10; }

        .sticky-col {
            position: sticky;
            left: 0;
            background: white !important;
            z-index: 20;
            border-right: 2px solid #f0f2f5;
            min-width: 140px; /* Un poco m√°s ancho para el bot√≥n */
            text-align: left;
            padding-left: 5px;
            display: flex;
            align-items: center;
        }

        th.sticky-col { background: #fcfcfc !important; z-index: 30; display: table-cell; }

        .week-num { font-size: 0.75em; font-weight: bold; color: #bbb; display: block; }
        .name-input { width: 100%; border: none; border-bottom: 1px solid transparent; padding: 3px; outline: none; background: transparent; font-weight: 600; font-size: 0.85em; }

        .check-cycle { font-size: 1.2em; user-select: none; cursor: pointer; display: inline-block; width: 24px; height: 24px; }
        
        .absent-count { font-weight: bold; color: #dc3545; font-size: 0.75em; padding: 2px 4px; border-radius: 4px; }
        
        .btn-add { background: rgba(255,255,255,0.3); border: 1px solid white; color: white; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 0.65em; }
        
        /* Bot√≥n Eliminar Visible */
        .btn-del { 
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            color: #dc3545; 
            border: 1px solid #ffccd0; 
            background: #fff5f5; 
            cursor: pointer; 
            font-size: 0.75em; 
            margin-right: 6px; 
            width: 18px;
            height: 18px;
            padding: 0;
            border-radius: 4px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; padding: 10px; max-width: 100%; }
        .btn-main { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; font-size: 0.85em; text-align: center; }
        .btn-copy { background: #25d366; grid-column: span 2; }
        .btn-photo { background: #3b82f6; }
        .btn-reset { background: #94a3b8; }

        /* Clase para ocultar SOLO en la exportaci√≥n */
        .export-hidden { display: none !important; }
    </style>
</head>
<body>

<div id="capture-area">
    <div class="header-top">
        <div class="input-group">
            <label>Fecha Reporte</label>
            <input type="date" id="date-picker">
        </div>
        <div class="input-group">
            <label>Semana</label>
            <select id="week-selector"></select>
        </div>
    </div>

    <div id="units-container"></div>
</div>

<div class="actions">
    <button class="btn-main btn-copy" onclick="copyToWhatsApp()">üìã Copiar para WhatsApp</button>
    <button class="btn-main btn-photo" onclick="takeScreenshot()">üì∏ Guardar Imagen</button>
    <button class="btn-main btn-reset" onclick="resetChecks()">üîÑ Reiniciar Checks</button>
</div>

<script>
    const units = [
        { id: 'urt', name: 'URT', fullName: 'UNIDAD ROJA', class: 'bg-urt', emoji: '‚ù§Ô∏è' },
        { id: 'uvt', name: 'UVT', fullName: 'UNIDAD VERDE', class: 'bg-uvt', emoji: 'üíö' },
        { id: 'uazt', name: 'UAzT', fullName: 'UNIDAD AZUL', class: 'bg-uazt', emoji: 'üíô' },
        { id: 'uamt', name: 'UAmT', fullName: 'UNIDAD AMARILLA', class: 'bg-uamt', emoji: 'üíõ' },
        { id: 'unt', name: 'UNT', fullName: 'UNIDAD NARANJA', class: 'bg-unt', emoji: 'üß°' }
    ];

    const states = ["‚¨ú", "‚úÖ", "‚ö†Ô∏è", "‚ùå"];

    function init() {
        setupInputs();
        renderUnits();
        loadFromStorage();
        syncScrolls();
    }

    function setupInputs() {
        const datePicker = document.getElementById('date-picker');
        if(!datePicker.value) datePicker.value = new Date().toISOString().split('T')[0];
        const weekSelector = document.getElementById('week-selector');
        for (let i = 1; i <= 13; i++) {
            let opt = document.createElement('option');
            opt.value = i; opt.text = `Ciclo Semana ${i}`;
            weekSelector.add(opt);
        }
    }

    function syncScrolls() {
        const containers = document.querySelectorAll('.table-responsive');
        containers.forEach(target => {
            target.addEventListener('scroll', () => {
                containers.forEach(other => {
                    if (other !== target) other.scrollLeft = target.scrollLeft;
                });
            });
        });
    }

    function renderUnits() {
        const container = document.getElementById('units-container');
        container.innerHTML = "";
        units.forEach(unit => {
            let weekHeaders = "";
            for(let i=1; i<=13; i++) weekHeaders += `<th><span class="week-num">${i}</span></th>`;

            container.innerHTML += `
                <div class="unit-section" id="sec-${unit.id}">
                    <div class="unit-header ${unit.class}">
                        <span>${unit.fullName}</span>
                        <button class="btn-add" onclick="addRow('${unit.id}')">+ Persona</button>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th class="sticky-col">Disc√≠pulo</th>
                                    ${weekHeaders}
                                    <th style="width:35px">F</th>
                                </tr>
                            </thead>
                            <tbody id="body-${unit.id}"></tbody>
                        </table>
                    </div>
                </div>`;
        });
    }

    function addRow(unitId, nameValue = "", savedChecks = []) {
        const body = document.getElementById(`body-${unitId}`);
        const tr = document.createElement('tr');
        let checksHtml = '';
        for(let i=0; i<13; i++) {
            const val = savedChecks[i] || "‚¨ú";
            checksHtml += `<td><span class="check-cycle" onclick="cycle(this)">${val}</span></td>`;
        }
        tr.innerHTML = `
            <td class="sticky-col">
                <button class="btn-del" onclick="removeRow(this)">‚úï</button>
                <input type="text" class="name-input" placeholder="Nombre..." value="${nameValue}" oninput="saveToStorage()">
            </td>
            ${checksHtml}
            <td><span class="absent-count"></span></td>
        `;
        body.appendChild(tr);
        updateRowAbsences(tr);
    }

    function removeRow(btn) {
        if(confirm("¬øEliminar a esta persona?")) {
            btn.closest('tr').remove();
            saveToStorage();
        }
    }

    function cycle(el) {
        let currentIndex = states.indexOf(el.innerText);
        el.innerText = states[(currentIndex + 1) % states.length];
        updateRowAbsences(el.closest('tr'));
        saveToStorage();
    }

    function updateRowAbsences(row) {
        const checks = Array.from(row.querySelectorAll('.check-cycle')).map(c => c.innerText);
        const injustificadas = checks.filter(e => e === "‚ùå").length;
        const justificadas = checks.filter(e => e === "‚ö†Ô∏è").length;
        const combinadas = injustificadas + justificadas;

        const display = row.querySelector('.absent-count');
        const inputNombre = row.querySelector('.name-input');

        const estaEliminado = (injustificadas >= 3 || justificadas >= 4 || combinadas >= 4);

        display.innerText = combinadas > 0 ? combinadas : "";

        if (estaEliminado) {
            inputNombre.style.textDecoration = "line-through";
            inputNombre.style.color = "#aaa";
            display.style.background = "#000";
            display.style.color = "#fff";
        } else {
            inputNombre.style.textDecoration = "none";
            inputNombre.style.color = "#333";
            display.style.background = "transparent";
            display.style.color = "#dc3545";
        }
    }

    function saveToStorage() {
        const data = {
            date: document.getElementById('date-picker').value,
            week: document.getElementById('week-selector').value,
            units: {}
        };
        units.forEach(unit => {
            data.units[unit.id] = Array.from(document.querySelectorAll(`#body-${unit.id} tr`)).map(row => ({
                name: row.querySelector('.name-input').value,
                checks: Array.from(row.querySelectorAll('.check-cycle')).map(c => c.innerText)
            }));
        });
        localStorage.setItem('app_unidades_vFINAL', JSON.stringify(data));
    }

    function loadFromStorage() {
        const saved = localStorage.getItem('app_unidades_vFINAL');
        if (saved) {
            const data = JSON.parse(saved);
            document.getElementById('date-picker').value = data.date;
            document.getElementById('week-selector').value = data.week;
            units.forEach(unit => {
                const body = document.getElementById(`body-${unit.id}`);
                body.innerHTML = "";
                if (data.units[unit.id] && data.units[unit.id].length > 0) {
                    data.units[unit.id].forEach(p => addRow(unit.id, p.name, p.checks));
                } else {
                    for(let i=0; i<2; i++) addRow(unit.id);
                }
            });
        } else {
            units.forEach(unit => {
                for(let i=0; i<2; i++) addRow(unit.id);
            });
        }
    }

    function resetChecks() {
        if(confirm("¬øLimpiar todos los marcadores?")) {
            document.querySelectorAll('.check-cycle').forEach(c => c.innerText = "‚¨ú");
            document.querySelectorAll('tr').forEach(tr => { if(tr.querySelector('.absent-count')) updateRowAbsences(tr); });
            saveToStorage();
        }
    }

    function copyToWhatsApp() {
        const dateP = document.getElementById('date-picker').value.split('-');
        const dateF = dateP.length > 1 ? `${dateP[2]}/${dateP[1]}/${dateP[0]}` : "";
        let text = `*REPORTE SEMANA ${document.getElementById('week-selector').value}* (${dateF})\n\n`;
        
        units.forEach(unit => {
            let uText = "";
            document.querySelectorAll(`#body-${unit.id} tr`).forEach(row => {
                let name = row.querySelector('.name-input').value.trim();
                if(name) {
                    const checksArr = Array.from(row.querySelectorAll('.check-cycle')).map(c => c.innerText);
                    const inj = checksArr.filter(e => e === "‚ùå").length;
                    const jus = checksArr.filter(e => e === "‚ö†Ô∏è").length;
                    const comb = inj + jus;
                    const chksText = checksArr.filter(e => e !== "‚¨ú").join("");
                    if (inj >= 3 || jus >= 4 || comb >= 4) name = `~${name.toUpperCase()}~`;
                    else name = name.toUpperCase();
                    uText += `‚Ä¢ *${name}*\n  ${chksText || "---"} ${comb > 0 ? `(F: ${comb})` : ''}\n`;
                }
            });
            if(uText) text += `${unit.emoji}*${unit.name}*${unit.emoji}\n${uText}\n`;
        });
        navigator.clipboard.writeText(text).then(() => alert("‚úÖ Reporte copiado"));
    }

    function takeScreenshot() {
        const area = document.getElementById('capture-area');
        const stickies = document.querySelectorAll('.sticky-col');
        const buttons = document.querySelectorAll('.btn-add, .btn-del');
        
        // Esconder botones para la foto
        buttons.forEach(b => b.classList.add('export-hidden'));
        stickies.forEach(s => s.style.position = 'static');

        html2canvas(area, { backgroundColor: "#f0f2f5", scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Reporte-${document.getElementById('date-picker').value}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            
            // Volver a mostrar botones
            stickies.forEach(s => s.style.position = 'sticky');
            buttons.forEach(b => b.classList.remove('export-hidden'));
        });
    }

    window.onload = init;
</script>
</body>

</html>
