<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidador General de Red</title>
    <style>

        :root {
            --roja: #dc3545;
            --azul: #007bff;
            --amarilla: #ffc107;
            --naranja: #fd7e14;
            --verde: #28a745;
        }

        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 15px; color: #333; padding-bottom: 30px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

        h1 { text-align: center; color: #333; margin: 0 0 25px 0; }

        /* Unidades (mismo ‚Äúbloque‚Äù visual de la primera app) */
        .unit-section { margin-bottom: 25px; border: 1px solid #dee2e6; border-radius: 10px; overflow: hidden; }
        .unit-header { padding: 12px; color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center; letter-spacing: 1px; }
        .u-roja .unit-header { background: var(--roja); }
        .u-azul .unit-header { background: var(--azul); }
        .u-amarilla .unit-header { background: var(--amarilla); color: #333; }
        .u-naranja .unit-header { background: var(--naranja); }
        .u-verde .unit-header { background: var(--verde); }

        textarea {
            width: 100%; height: 140px;
            border: 1px solid #eee; border-top: none;
            padding: 12px; box-sizing: border-box; resize: vertical;
            font-family: monospace; font-size: 0.9em;
            background: #fafafa; color: #111;
            outline: none;
        }
        .u-roja textarea:focus { border-color: var(--roja); }
        .u-azul textarea:focus { border-color: var(--azul); }
        .u-amarilla textarea:focus { border-color: var(--amarilla); }
        .u-naranja textarea:focus { border-color: var(--naranja); }
        .u-verde textarea:focus { border-color: var(--verde); }

        .action-bar { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .btn-main { padding: 12px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 8px; font-size: 0.95em; }
        .btn-blue { background: #007bff; }
        .btn-blue:active { transform: scale(0.98); }
        .btn-red { background: #dc3545; }
        .btn-red:active { transform: scale(0.98); }

        #status-msg { text-align: center; font-size: 0.9em; color: #666; margin-top: 10px; min-height: 1.2em; }

    </style>
</head>
<body>

<div class="container">
    <h1>üìä CONSOLIDADO</h1>
    
    <div id="units-container"></div>
    <div id="status-msg"></div>
    <div class="action-bar">
        <button id="btn-copy" class="btn-main btn-blue" onclick="copyFinalReport()">üìã COPIAR REPORTE COMPLETO</button>
        <button id="btn-reset" class="btn-main btn-red" onclick="resetData()"> RESETEAR</button>
    </div>
</div>

<script>
    const units = [
        { id: 'ROJA', color: 'u-roja' },
        { id: 'AZUL', color: 'u-azul' },
        { id: 'AMARILLA', color: 'u-amarilla' },
        { id: 'NARANJA', color: 'u-naranja' },
        { id: 'VERDE', color: 'u-verde' }
    ];

    const STORAGE_KEY = 'reporte_red_completo_data_v1';

    function saveAll() {
        const data = {};
        units.forEach(u => {
            const el = document.getElementById(`txt-${u.id}`);
            data[u.id] = el ? el.value : '';
        });
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) {}
    }

    function loadAll() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if(!raw) return;
            const data = JSON.parse(raw);
            units.forEach(u => {
                const el = document.getElementById(`txt-${u.id}`);
                if(el && typeof data[u.id] === 'string') el.value = data[u.id];
            });
        } catch(e) {}
    }

    function resetData() {
        try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}
        units.forEach(u => {
            const el = document.getElementById(`txt-${u.id}`);
            if(el) el.value = '';
        });
        window.finalReportStr = '';
        const status = document.getElementById('status-msg');
        if(status) status.innerText = '';
        const btn = document.getElementById('btn-copy');
        if(btn) {
            btn.innerText = 'üìã COPIAR REPORTE COMPLETO';
            btn.style.background = '#007bff';
        }
    }


    const container = document.getElementById('units-container');
    units.forEach(u => {
        container.innerHTML += `
            <div class="unit-section ${u.color}">
                <div class="unit-header">UNIDAD ${u.id}</div>
                <textarea id="txt-${u.id}" placeholder="Pegar reporte aqu√≠..." oninput="calculateAll()"></textarea>
            </div>
        `;
    });

    
    // Cargar datos persistidos al iniciar
    loadAll();
    calculateAll();
function extractValue(text, regex) {
        const parts = text.split(/RESUMEN OFRENDAS ACUMULADO/i);
        if (parts.length < 2) return 0;
        const summaryText = parts[1];
        const match = summaryText.match(regex);
        if (!match) return 0;
        let val = match[1].replace(/[‚Ç°\s.]/g, '').replace(',', '.');
        return parseFloat(val) || 0;
    }

    function calculateAll() {
        let grandTotals = { s: 0, e: 0, rjC: 0, tkC: 0, rjR: 0, tkR: 0, rjN: 0, tkN: 0 };
        let fullDetailBody = "";
        let unitsActive = 0;

        units.forEach(u => {
            const val = document.getElementById(`txt-${u.id}`).value;
            if(!val || val.trim() === "") return;
            unitsActive++;

            const s = extractValue(val, /Sinpes?:\s*‚Ç°?([\d\s.,]+)/i);
            const e = extractValue(val, /Efectivo:\s*‚Ç°?([\d\s.,]+)/i);
            const rc = extractValue(val, /RJ C√©lula:\s*(\d+)/i);
            const tc = extractValue(val, /Takers C√©lula:\s*(\d+)/i);
            const rr = extractValue(val, /RJ Red:\s*(\d+)/i);
            const tr = extractValue(val, /Takers Red:\s*(\d+)/i);
            const rn = extractValue(val, /RJ Nuevos:\s*(\d+)/i);
            const tn = extractValue(val, /Takers Nuevos:\s*(\d+)/i);

            grandTotals.s += s; grandTotals.e += e;
            grandTotals.rjC += rc; grandTotals.tkC += tc;
            grandTotals.rjR += rr; grandTotals.tkR += tr;
            grandTotals.rjN += rn; grandTotals.tkN += tn;

            fullDetailBody += `*‚ù£Ô∏èUNIDAD ${u.id}‚ù£Ô∏è*\n` +
                `üìä RESUMEN OFRENDAS ACUMULADO\n` +
                `Sinpes: ‚Ç°${s.toLocaleString('es-CR')}\n` +
                `Efectivo: ‚Ç°${e.toLocaleString('es-CR')}\n` +
                `Total: ‚Ç°${(s + e).toLocaleString('es-CR')}\n\n` +
                `---üë• RESUMEN ASISTENCIA ACUMULADO---\n` +
                `-> C√©lula\n` +
                `RJ C√©lula: ${rc}\n` +
                `Takers C√©lula: ${tc}\n` +
                `Total C√©lula: ${rc + tc}\n\n` +
                `-> Red\n` +
                `RJ Red: ${rr}\n` +
                `Takers Red: ${tr}\n` +
                `Total Red: ${rr + tr}\n\n` +
                `-> Nuevos\n` +
                `RJ Nuevos: ${rn}\n` +
                `Takers Nuevos: ${tn}\n` +
                `Total Nuevos: ${rn + tn}\n` +
                `==============================\n\n`;
        });

        if (unitsActive > 0) {
            const finalSumatory = `*üöÄ SUMATORIA GENERAL DE RED*\n\n` +
                `üí∞ *OFRENDAS TOTALES*\n` +
                `Sinpes: ‚Ç°${grandTotals.s.toLocaleString('es-CR')}\n` +
                `Efectivo: ‚Ç°${grandTotals.e.toLocaleString('es-CR')}\n` +
                `Total: ‚Ç°${(grandTotals.s + grandTotals.e).toLocaleString('es-CR')}\n\n` +
                `üë• *ASISTENCIA TOTAL*\n` +
                `-> C√©lula\n` +
                `RJ C√©lula: ${grandTotals.rjC}\n` +
                `Takers C√©lula: ${grandTotals.tkC}\n` +
                `Total C√©lula: ${grandTotals.rjC + grandTotals.tkC}\n\n` +
                `-> Red\n` +
                `RJ Red: ${grandTotals.rjR}\n` +
                `Takers Red: ${grandTotals.tkR}\n` +
                `Total Red: ${grandTotals.rjR + grandTotals.tkR}\n\n` +
                `-> Nuevos\n` +
                `RJ Nuevos: ${grandTotals.rjN}\n` +
                `Takers Nuevos: ${grandTotals.tkN}\n` +
                `Total Nuevos: ${grandTotals.rjN + grandTotals.tkN}`;

            window.finalReportStr = fullDetailBody + finalSumatory;
            document.getElementById('status-msg').innerText = "‚úÖ Reporte actualizado y listo";
        } else {
            window.finalReportStr = "";
            document.getElementById('status-msg').innerText = "";
        }
        saveAll();
    }

    function copyFinalReport() {
        if(!window.finalReportStr) {
            alert("Por favor, ingresa datos en al menos una unidad.");
            return;
        }
        navigator.clipboard.writeText(window.finalReportStr);
        const btn = document.querySelector('.btn-main');
        btn.innerText = "¬°COPIADO! ‚úÖ";
        btn.style.background = "#28a745";
        setTimeout(() => {
            btn.innerText = "üìã COPIAR REPORTE COMPLETO";
            btn.style.background = "#007bff";
        }, 2000);
    }
</script>
</body>
</html>
